# Check that package-lock.json is in sync with package.json
echo "ğŸ” Checking package-lock.json sync..."
npm ci --dry-run 2>&1 | grep -q "npm error" && {
    echo "âŒ package-lock.json is out of sync with package.json"
    echo "Run 'npm install' to update the lock file, then stage package-lock.json"
    exit 1
}
echo "âœ… package-lock.json is in sync"

# Check for oversized images (>400kB)
OVERSIZED=$(find . -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" \) ! -path "./node_modules/*" ! -path "./.git/*" ! -path "./dist/*" ! -name "*.bk" -size +400k 2>/dev/null)

if [ -n "$OVERSIZED" ]; then
    echo "âŒ Found images larger than 400kB:"
    echo "$OVERSIZED"
    echo ""
    echo "Run 'npm run optimize:images' to optimize them."
    exit 1
fi
echo "âœ… No oversized images found"

# Check for AI/Google metadata in images
echo "ğŸ” Checking for AI/Google metadata in images..."
python3 scripts/strip_ai_metadata.py --check
if [ $? -ne 0 ]; then
    exit 1
fi
echo "âœ… No AI metadata found in images"

# Check for em dash character (â€”) usage
EM_DASH_FILES=$(git diff --cached --name-only | grep -v "^\.husky/" | xargs grep -l "â€”" 2>/dev/null || true)

if [ -n "$EM_DASH_FILES" ]; then
    echo "âŒ Found em dash character (â€”) in the following files:"
    echo "$EM_DASH_FILES"
    echo ""
    echo "Please do not use the em dash (â€”) character in text."
    echo "Instead, prefer using:"
    echo "  â€¢ Commas (,) for pauses"
    echo "  â€¢ Colons (:) for introducing lists or explanations"
    echo "  â€¢ Rephrasing the sentence for better clarity"
    exit 1
fi
echo "âœ… No em dash characters found"

# Run lint-staged for formatting and linting
echo "ğŸ” Running lint-staged..."
npx lint-staged

# Run Prettier format check to ensure all files are formatted
echo "ğŸ” Checking code formatting..."
npm run format:check || {
    echo "âŒ Code formatting issues found. Run 'npm run format' to fix them."
    exit 1
}
echo "âœ… Code formatting check passed"

# Run full lint check
echo "ğŸ” Running ESLint..."
npm run lint || {
    echo "âŒ ESLint errors found. Run 'npm run lint:fix' to fix them."
    exit 1
}
echo "âœ… ESLint check passed"

# Run TypeScript type check
echo "ğŸ” Running TypeScript type check..."
npm run typecheck || {
    echo "âŒ TypeScript type errors found. Fix the errors above."
    exit 1
}
echo "âœ… TypeScript type check passed"

# Run Knip for dead code detection
echo "ğŸ” Checking for dead code..."
npm run knip || {
    echo "âŒ Dead code or unused exports found. Run 'npm run knip:fix' to fix them."
    exit 1
}
echo "âœ… No dead code found"

# Run unit tests
echo "ğŸ” Running unit tests..."
npm run test:run || {
    echo "âŒ Unit tests failed. Fix the failing tests above."
    exit 1
}
echo "âœ… All unit tests passed"

echo ""
echo "ğŸ‰ All pre-commit checks passed!"
